name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: >
          Release version (e.g. 1.2.3).
          Leave blank to auto-bump the patch number from the latest release tag.
        required: false
        default: ''
      prerelease:
        description: 'Mark as pre-release'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      # ── Checkout ──────────────────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0        # needed to read tags for version bumping

      # ── Resolve version ───────────────────────────────────────────────────
      - name: Resolve version
        id: version
        shell: pwsh
        run: |
          $v = "${{ inputs.version }}".Trim()
          if (-not $v) {
            # Try to bump patch from the latest semver tag (vX.Y.Z only)
            $latest = git tag --list --sort=-version:refname 'v[0-9]*.[0-9]*.[0-9]*' |
                        Select-Object -First 1
            if ($latest -and "$latest" -match '^v?(\d+)\.(\d+)\.(\d+)$') {
              $v = "$($Matches[1]).$($Matches[2]).$([int]$Matches[3] + 1)"
            } else {
              # Fall back to the version declared in CMakeLists.txt
              $m = Select-String -Path CMakeLists.txt `
                    -Pattern 'project\(ShaderLab\s+VERSION\s+(\S+)' |
                    Select-Object -First 1
              $v = if ($m) { $m.Matches[0].Groups[1].Value } else { "1.0.0" }
            }
          }
          "version=$v" | Out-File -Append $env:GITHUB_OUTPUT
          "tag=v$v"    | Out-File -Append $env:GITHUB_OUTPUT
          Write-Host "::notice::Release version resolved to $v"

      # ── Stamp version into source ─────────────────────────────────────────
      - name: Stamp version into CMakeLists.txt
        shell: pwsh
        run: |
          $v = "${{ steps.version.outputs.version }}"
          (Get-Content CMakeLists.txt -Raw) `
            -replace '(project\(ShaderLab\s+VERSION\s+)[\d.]+', "`${1}$v" |
            Set-Content CMakeLists.txt -NoNewline

      # ── MSVC build environment ────────────────────────────────────────────
      - name: Set up MSVC (x64)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ── Install Inno Setup ────────────────────────────────────────────────
      - name: Install Inno Setup
        shell: pwsh
        run: choco install innosetup --yes --no-progress

      # ── Third-party dependencies ──────────────────────────────────────────
      - name: Download third-party dependencies
        shell: pwsh
        run: |
          $tp = "third_party"

          # ---- Dear ImGui (docking branch) --------------------------------
          $imguiDir = "$tp\imgui"
          if (-not (Test-Path "$imguiDir\imgui.h")) {
            Write-Host "Downloading Dear ImGui (docking)..."
            $zip = "$env:TEMP\imgui-docking.zip"
            Invoke-WebRequest `
              -Uri "https://github.com/ocornut/imgui/archive/refs/heads/docking.zip" `
              -OutFile $zip -UseBasicParsing
            Expand-Archive $zip -DestinationPath $env:TEMP -Force
            New-Item -ItemType Directory -Force -Path $imguiDir | Out-Null
            Copy-Item "$env:TEMP\imgui-docking\*" $imguiDir -Recurse -Force
            Remove-Item "$env:TEMP\imgui-docking", $zip -Recurse -Force
          }

          # ---- miniaudio --------------------------------------------------
          $miniAudio = "$tp\miniaudio\miniaudio.h"
          if (-not (Test-Path $miniAudio)) {
            Write-Host "Downloading miniaudio..."
            New-Item -ItemType Directory -Force -Path "$tp\miniaudio" | Out-Null
            Invoke-WebRequest `
              -Uri "https://raw.githubusercontent.com/mackron/miniaudio/master/miniaudio.h" `
              -OutFile $miniAudio -UseBasicParsing
          }

          # ---- nlohmann/json ----------------------------------------------
          $jsonH = "$tp\json\include\nlohmann\json.hpp"
          if (-not (Test-Path $jsonH)) {
            Write-Host "Downloading nlohmann/json..."
            New-Item -ItemType Directory -Force -Path (Split-Path $jsonH) | Out-Null
            Invoke-WebRequest `
              -Uri "https://raw.githubusercontent.com/nlohmann/json/develop/single_include/nlohmann/json.hpp" `
              -OutFile $jsonH -UseBasicParsing
          }

          # ---- stb_image --------------------------------------------------
          $stb = "$tp\stb\stb_image.h"
          if (-not (Test-Path $stb)) {
            Write-Host "Downloading stb_image..."
            New-Item -ItemType Directory -Force -Path "$tp\stb" | Out-Null
            Invoke-WebRequest `
              -Uri "https://raw.githubusercontent.com/nothings/stb/master/stb_image.h" `
              -OutFile $stb -UseBasicParsing
          }

          # ---- OpenFontIcons ----------------------------------------------
          $openFontIconsTtf = "$tp\OpenFontIcons\OpenFontIcons.ttf"
          if (-not (Test-Path $openFontIconsTtf)) {
            Write-Host "Downloading OpenFontIcons..."
            New-Item -ItemType Directory -Force -Path "$tp\OpenFontIcons" | Out-Null
            Invoke-WebRequest `
              -Uri "https://github.com/traverseda/OpenFontIcons/raw/master/OpenFontIcons.ttf" `
              -OutFile $openFontIconsTtf -UseBasicParsing
          }

      # ── Configure & build ─────────────────────────────────────────────────
      - name: Configure (Release)
        shell: pwsh
        run: cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build (Release)
        shell: pwsh
        run: cmake --build build --config Release

      # ── Stage end-user docs ───────────────────────────────────────────────
      - name: Stage end-user docs
        shell: pwsh
        run: .\tools\stage_enduser_docs.ps1

      # ── Windows Installer (Inno Setup) ────────────────────────────────────
      # build_installer.ps1 automatically locates and bundles vc_redist.x64.exe
      # from the VS installation on the runner.
      - name: Build Windows installer
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          .\tools\build_installer.ps1 `
            -Version "${{ steps.version.outputs.version }}" `
            -OutputDir artifacts

      # ── Portable ZIP ──────────────────────────────────────────────────────
      - name: Create portable ZIP
        shell: pwsh
        run: |
          $v = "${{ steps.version.outputs.version }}"
          Compress-Archive `
            -Path "build\installer_stage\app\*" `
            -DestinationPath "artifacts\ShaderLabEditor-x64-$v-portable.zip"

      # ── Tag & publish release ─────────────────────────────────────────────
      - name: Create and push release tag
        shell: pwsh
        run: |
          $tag = "${{ steps.version.outputs.tag }}"
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag $tag
          git push origin $tag

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ShaderLab Editor ${{ steps.version.outputs.tag }}
          draft: false
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            artifacts/*.exe
            artifacts/*.zip
